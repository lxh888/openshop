#### 事务

```
db()::work([string $command][,closure $closure]);
```
|类型|参数|备注|是否必须|默认值|顺序|
| ----| ----|----|----|----|----|
|string|$command|操作命令|否||string[0]|
|closure|$closure|闭包函数|否|	|closure[0]	|

- $closure 最多接受1个参数，如function($resource){}，$resource就是当前标识的资源。不接受闭包函数的返回值。

##### 命令参考：

| 命令 | 备注 |
|---|---| ---| 
|b | backups 备份恢复数据，回滚时恢复 |
|f | freeze 冻结数据，回滚时删除 |
|r | rollback 手动回滚|
|c | close 关闭事务 |

- 命令是不区分大小写的。
- 命令可以同时存在。
- 多个命令同时存在执行的优先级(备份先，再回滚，最后关闭)：b>f>r>c
 

##### 开启事务

```
db('测试')->work();
```

##### 开启事务并且备份

```
db('测试')->table('user')->where(array('id = 2'))->work('b');
```

##### 回滚
有些时候，业务上出现这样的需求，也就是需要将数据马上回滚，操作如下：

```
db('测试')->work('r');
```
如果不手动关闭事务，那么备份的数据也会自动回滚。

```
//开启 事务，并且备份数据
db('测试')->table('user')->where(array('id = 2'))->work('b');
db('测试')->table('user')->where(array('id = 2'))->update(array('name'=>'888'));
//如果没有手动关闭事务，那么结束时，会自动回滚
```

下面手动关闭事务，那么修改数据才能成功。

```
//手动关闭事务
db('测试')->work('c');
```

##### 备份出错时需要删除的数据
有些时候，我们新增了数据，但是在某些情况下需要删除回滚。

```
//新增一条数据，返回自增id
$id = db('测试')->table('user')->insert(array('name'=>'王阿和'));
//备份要删除的数据，回滚时自动删除
db('测试')->table('user')->where(array('id = []', $id))->work('f');

//没有手动关闭事务，那么程序结束或者程序出错，数据将会自动回滚，删除 $id 的数据。
```
下面手动关闭事务，那么新增数据才能成功。

```
//手动关闭事务
db('测试')->work('c');
```

##### 自动回滚
有错误或是在手动关闭事务之前终止程序，那么就会自动回滚数据：

```
//新增一条数据，返回自增id
$id = db('测试')->table('user')->insert(array('name'=>'王阿和'));
//备份要删除的数据，回滚时自动删除
db('测试')->table('user')->where(array('id = []', $id))->work('f');

//报错，a函数不存在
a();

//关闭事务无效，前面发生了错误
db('测试')->work('c');
```


##### 手动关闭事务
会删除备份的数据，并且删除并清除备份文件及地址信息。

```
db('测试')->work('c');
```


##### 命令执行的优先级
b>f>r>c：

```
$id = db('测试')->table('user')->insert(array('name'=>'王阿和'));
//这里先执行“b”再执行的“f”，并不是命令书写的次序
db('测试')->table('user')->where(array('id = []', $id))->work('fb');
db('测试')->work('c');
```
