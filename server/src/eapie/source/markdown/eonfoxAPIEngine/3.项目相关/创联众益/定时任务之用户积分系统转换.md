# 定时任务的需求

## 关于转换率
- 转换率基数：设为0.0003 即万分之三。
- 最大转换率：设为0.0010 此参数为了预防风险。
- 最小转换率：设为 0.0001 转换率是不能低于该值。
- 上一天商家消费人民币之和：是上一天所有商家购买库存积分所花费的人民币之和。
- 今天商家消费人民币之和：是今天所有商家购买库存积分所花费的人民币之和。

获得转换率的计算公式：
`(((今天商家消费人民币之和 - 上一天商家消费人民币之和) / 上一天商家消费人民币之和) + 1) * 转换率基数`

#### 场景示例：

| 情况 | 上一天商家消费人民币之和	| 今天商家消费人民币之和	| 转换率（人民币单位元）|
| --- | --- | --- | --- |
|上一天 小于 今天|	1000元	| 2000元 |	(((2000-1000)/1000)+1)*0.0003 = 0.0006 | 
|上一天 大于 今天|	2000元|	500元|	(((500-2000)/2000)+1)*0.0003 = 0.000075 （舍去法保留5位小数：0.00007，是小于【最小转换率】，那么该值为：最小转换率0.0001）| 
|上一天 等于 今天|	1000元|	1000元|	1*0.0003 = 0.0003| 
|上一天无消费记录|	0	|1000元|	1*0.0003 = 0.0003| 
|今天无消费记录|	1500元|	0	|(((0-1500)/1500)+1)*0.0003 = 最小转换率| 
|上一天与今天皆无消费|	0|	0|	最小转换率|

精确度保留5位，以舍去法进位，后台可以修改。


## 关于系统自动转换用户积分
- 转换倍数积分：即积分要达到这个倍数才能被转换。

获得共享金的计算公式，(注意计算单位)：
`用户的个人消费积分(元) * 转换率(元)`
获得多少用户共享金，则减去其多少消费积分。（这里把消费积分看作人民币元）。

## 定时任务的接口链接
`https://developer.eapie.eonfox.com/index.php/temp/application/chuanglianzhongyi_test/data/PROJECTCLZYEVENTSYSTEMCONVERSION`
- 其中temp表示为临时访问的意思，这样就不需要token参数，不需要初始化会话信息
- `application/chuanglianzhongyi_test`参数表示应用ID访问的是`chuanglianzhongyi_test`创联众益的测试版
- `data/PROJECTCLZYEVENTSYSTEMCONVERSION`参数表示接口ID是`PROJECTCLZYEVENTSYSTEMCONVERSION`

# 代码相关

## 位置
`request/project/clzy.php`

```
/**
 * 定时任务系统转换
 * 
 * @param	void		
 * @return  void
 */
public function api_event_system_conversion(){};
```

## 分析
`object(parent::TABLE_EVENT)->get_event_data()`是获取事件数据，如果不存在，则会创建一条新数据。第一个参数是事件名称(event_name)，第二个参数是事件标识(event_stamp)

